services:
  # FastAPI ì„œë¹„ìŠ¤
  fastapi:
    build: .
    container_name: fastapi
    env_file:
      - .env  # ğŸ”¥ .env íŒŒì¼ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€
    ports:
      - "8000:8000"
    depends_on:
      - db  # MySQL DB ì˜ì¡´ì„± ì¶”ê°€
    environment:
      DATABASE_URL: "${DATABASE_PY_URL}"  # í™˜ê²½ë³€ìˆ˜ DATABASE_PY_URL
      MONGO_PW: "${MONGO_PW}"  # MongoDB íŒ¨ìŠ¤ì›Œë“œ ì¶”ê°€
      USE_PROXY_HEADERS: "True"  # âœ… í”„ë¡ì‹œ í—¤ë” ì‹ ë¢° ì„¤ì •
      FASTAPI_FORWARDED_ALLOW_IPS: "*"  # âœ… ëª¨ë“  í”„ë¡ì‹œ IP í—ˆìš©

  # MySQL DB ì„œë¹„ìŠ¤
  db:
    image: mysql:8.0
    container_name: mysql-db
    restart: always
    env_file:
      - .env  # ğŸ”¥ .env íŒŒì¼ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PW}  # MySQL ë£¨íŠ¸ íŒ¨ìŠ¤ì›Œë“œ
      MYSQL_DATABASE: ${RDS_DB_NAME}  # MySQL DB ì´ë¦„
    ports:
      - "3306:3306"  # DB í¬íŠ¸
    volumes:
      - mysql_data:/var/lib/mysql  # MySQL ë°ì´í„° ë³¼ë¥¨

  # Nginx ì„œë¹„ìŠ¤ (Reverse Proxy ì—­í• )
  nginx:
    image: nginx:latest
    container_name: nginx
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf  # Nginx ì„¤ì • íŒŒì¼
      - ./certs:/etc/letsencrypt  # ì¸ì¦ì„œ ì €ì¥ì†Œ
      - ./data:/var/www/certbot  # Certbot ì›¹ ë£¨íŠ¸
    ports:
      - "80:80"  # HTTP í¬íŠ¸
      - "443:443"  # HTTPS í¬íŠ¸
    restart: unless-stopped

  # Certbot ì„œë¹„ìŠ¤ (SSL ì¸ì¦ì„œ ê´€ë¦¬)
  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - ./certs:/etc/letsencrypt  # ì¸ì¦ì„œ ì €ì¥ì†Œ
      - ./data:/var/www/certbot  # Certbot ì›¹ ë£¨íŠ¸
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

# MySQL ë°ì´í„° ì˜ì†ì„±ì„ ìœ„í•œ ë³¼ë¥¨
volumes:
  mysql_data:
